import { Injectable, Logger } from '@nestjs/common';
import axios from 'axios';

@Injectable()
export class WhatsAppNotificationService {
  private readonly logger = new Logger(WhatsAppNotificationService.name);
  private readonly evolutionApiUrl = 'https://back-evolution-api.l4h6aa.easypanel.host';
  private readonly apiKey = '98B50032DFC9-42D0-A1CF-A46CC84898C0';

  /**
   * Convierte kil√≥metros a millas
   * @param kilometers Distancia en kil√≥metros
   * @returns Distancia en millas
   */
  private convertKmToMiles(kilometers: number): number {
    return kilometers * 0.621371;
  }

  async sendCancellationMessageToDriver(
    driverPhone: string,
    rideInfo: {
      trackingCode: string;
      origin: string;
      destination: string;
      clientName?: string;
    }
  ): Promise<boolean> {
    try {
      // Formatear el n√∫mero de tel√©fono para WhatsApp
      const formattedPhone = this.formatPhoneForWhatsApp(driverPhone);
      
      // Crear mensaje amigable y humanizado
      const message = this.createCancellationMessage(rideInfo);

      const payload = {
        number: formattedPhone,
        text: message
      };

      const response = await axios.post(
        `${this.evolutionApiUrl}/message/sendText/Pavola`,
        payload,
        {
          headers: {
            'Content-Type': 'application/json',
            'apikey': this.apiKey
          },
          timeout: 10000 // 10 segundos de timeout
        }
      );

      if (response.status === 200 || response.status === 201) {
        this.logger.log(
          `Mensaje de cancelaci√≥n enviado exitosamente al conductora ${driverPhone} ` +
          `para la carrera ${rideInfo.trackingCode}`
        );
        return true;
      } else {
        this.logger.warn(
          `Respuesta inesperada de Evolution API: ${response.status} - ${response.statusText}`
        );
        return false;
      }

    } catch (error) {
      this.logger.error(
        `Error al enviar mensaje de cancelaci√≥n al conductora ${driverPhone}: ${error.message}`,
        error.stack
      );
      return false;
    }
  }

  private formatPhoneForWhatsApp(phone: string): string {
    // Remover caracteres no num√©ricos
    const cleanPhone = phone.replace(/\D/g, '').replace('+', '');
    
    // Si ya tiene c√≥digo de pa√≠s, usarlo tal como est√°
    return cleanPhone;
  }

  private createCancellationMessage(rideInfo: {
    trackingCode: string;
    origin: string;
    destination: string;
    clientName?: string;
  }): string {
    const clientInfo = rideInfo.clientName ? ` de ${rideInfo.clientName}` : '';
    
    return `üö´ *Viaje Cancelado*

Hola, lamentamos informarte que el viaje${clientInfo} ha sido cancelado.

üìã *Detalles del viaje:*
‚Ä¢ C√≥digo: ${rideInfo.trackingCode}
‚Ä¢ Origen: ${rideInfo.origin}
‚Ä¢ Destino: ${rideInfo.destination}

Puedes continuar recibiendo nuevos viajes. ¬°Gracias por tu comprensi√≥n! üöóüí®`;
  }

  async sendTestMessage(phone: string, message: string): Promise<boolean> {
    try {
      const formattedPhone = this.formatPhoneForWhatsApp(phone);
      
      const payload = {
        number: formattedPhone,
        text: message
      };

      const response = await axios.post(
        `${this.evolutionApiUrl}/message/sendText/Pavola`,
        payload,
        {
          headers: {
            'Content-Type': 'application/json',
            'apikey': this.apiKey
          },
          timeout: 10000
        }
      );

      return response.status === 200 || response.status === 201;
    } catch (error) {
      this.logger.error(`Error al enviar mensaje de prueba: ${error.message}`);
      return false;
    }
  }

  /**
   * Env√≠a c√≥digo OTP por WhatsApp como fallback cuando SMS falla
   * @param driverPhone N√∫mero de tel√©fono de la conductora
   * @param otpCode C√≥digo OTP de 6 d√≠gitos
   * @param platform Plataforma del dispositivo (opcional)
   * @param appHash Hash de la aplicaci√≥n Android (opcional)
   * @returns Promise<boolean> true si se envi√≥ exitosamente
   */
  async sendOtpViaWhatsApp(driverPhone: string, otpCode: string, platform?: string, appHash?: string): Promise<boolean> {
    try {
      // Formatear el n√∫mero de tel√©fono para WhatsApp
      const formattedPhone = this.formatPhoneForWhatsApp(driverPhone);
      
      // Crear mensaje de OTP con formato claro
      const message = this.createOtpMessage(otpCode, platform, appHash);

      const payload = {
        number: formattedPhone,
        text: message
      };

      const response = await axios.post(
        `${this.evolutionApiUrl}/message/sendText/Pavola`,
        payload,
        {
          headers: {
            'Content-Type': 'application/json',
            'apikey': this.apiKey
          },
          timeout: 10000 // 10 segundos de timeout
        }
      );

      if (response.status === 200 || response.status === 201) {
        this.logger.log(
          `C√≥digo OTP enviado exitosamente por WhatsApp al conductora ${driverPhone}: ${otpCode}`
        );
        return true;
      } else {
        this.logger.warn(
          `Respuesta inesperada de Evolution API para OTP: ${response.status} - ${response.statusText}`
        );
        return false;
      }

    } catch (error) {
      this.logger.error(
        `Error al enviar OTP por WhatsApp al conductora ${driverPhone}: ${error.message}`,
        error.stack
      );
      return false;
    }
  }

  /**
   * Crea el mensaje de OTP para WhatsApp
   * @param otpCode C√≥digo OTP de 6 d√≠gitos
   * @param platform Plataforma del dispositivo (opcional)
   * @param appHash Hash de la aplicaci√≥n Android (opcional)
   * @returns Mensaje formateado para WhatsApp
   */
  private createOtpMessage(otpCode: string, platform?: string, appHash?: string): string {
    let message = `üîê *C√≥digo de Verificaci√≥n - Taxi Rosa*

Tu c√≥digo de verificaci√≥n es: *${otpCode}*

‚ö†Ô∏è *Importante:*
‚Ä¢ Este c√≥digo expira en 10 minutos
‚Ä¢ No compartas este c√≥digo con nadie
‚Ä¢ √ösalo para iniciar sesi√≥n en la app

üöó ¬°Gracias por usar Taxi Rosa!`;

    // Si es Android y tiene app_hash, agregar el hash al final para detecci√≥n autom√°tica
    if (platform === 'android' && appHash) {
      message += `\n\n${appHash}`;
    }

    return message;
  }

  async sendWelcomeMessageToDriver(
    driverPhone: string,
    driverInfo: {
      firstName: string;
      lastName: string;
      licencePlate: string;
      vehicle: string;
    }
  ): Promise<boolean> {
    try {
      // Formatear el n√∫mero de tel√©fono para WhatsApp
      const formattedPhone = this.formatPhoneForWhatsApp(driverPhone);
      
      // Crear mensaje de bienvenida personalizado
      const message = this.createWelcomeMessage(driverInfo);

      const payload = {
        number: formattedPhone,
        text: message,
        linkPreview: true
      };

      const response = await axios.post(
        `${this.evolutionApiUrl}/message/sendText/Pavola`,
        payload,
        {
          headers: {
            'Content-Type': 'application/json',
            'apikey': this.apiKey
          },
          timeout: 10000 // 10 segundos de timeout
        }
      );
      if (response.status === 200 || response.status === 201) {
        this.logger.log(
          `Mensaje de bienvenida enviado exitosamente al conductora ${driverPhone} ` +
          `(${driverInfo.firstName} ${driverInfo.lastName})`
        );
        return true;
      } else {
        this.logger.warn(
          `Respuesta inesperada de Evolution API: ${response.status} - ${response.statusText}`
        );
        return false;
      }

    } catch (error) {
      this.logger.error(
        `Error al enviar mensaje de bienvenida al conductora ${driverPhone}: ${error.message}`,
        error.stack
      );
      return false;
    }
  }

  async sendTripCompletionMessageToClient(
    clientPhone: string,
    rideInfo: {
      trackingCode: string;
      origin: string;
      destination: string;
      price: number;
      distance?: number;
      duration?: number;
      driverName: string;
      driverVehicle: string;
      driverPlate: string;
      completionDate: Date;
    }
  ): Promise<boolean> {
    try {
      // Formatear el n√∫mero de tel√©fono para WhatsApp
      const formattedPhone = this.formatPhoneForWhatsApp(clientPhone);
      
      // Crear mensaje de factura personalizado
      const message = this.createTripCompletionMessage(rideInfo);

      const payload = {
        number: formattedPhone,
        text: message
      };
      console.log(payload, 'payload');

      const response = await axios.post(
        `${this.evolutionApiUrl}/message/sendText/Pavola`,
        payload,
        {
          headers: {
            'Content-Type': 'application/json',
            'apikey': this.apiKey
          },
          timeout: 10000 // 10 segundos de timeout
        }
      );

      if (response.status === 200 || response.status === 201) {
        this.logger.log(
          `Mensaje de viaje completado enviado exitosamente al cliente ${clientPhone} ` +
          `para la carrera ${rideInfo.trackingCode}`
        );
        return true;
      } else {
        this.logger.warn(
          `Respuesta inesperada de Evolution API: ${response.status} - ${response.statusText}`
        );
        return false;
      }

    } catch (error) {
      this.logger.error(
        `Error al enviar mensaje de viaje completado al cliente ${clientPhone}: ${error.message}`,
        error.stack
      );
      return false;
    }
  }

  private createTripCompletionMessage(rideInfo: {
    trackingCode: string;
    origin: string;
    destination: string;
    price: number;
    distance?: number;
    duration?: number;
    driverName: string;
    driverVehicle: string;
    driverPlate: string;
    completionDate: Date;
  }): string {
    const formatPrice = (price: number) => `$${Number(price || 0).toFixed(2)}`;
    const formatTime = (date: Date) => date.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit',
      hour12: true 
    });
    const formatDate = (date: Date) => date.toLocaleDateString('en-US', {
      day: '2-digit',
      month: '2-digit', 
      year: 'numeric'
    });

    let distanceInfo = '';
    if (rideInfo.distance && !isNaN(Number(rideInfo.distance))) {
      const distanceKm = Number(rideInfo.distance);
      const distanceMiles = this.convertKmToMiles(distanceKm);
      distanceInfo = `‚Ä¢ Distancia: ${distanceMiles.toFixed(1)} millas\n`;
    }

    let durationInfo = '';
    if (rideInfo.duration && !isNaN(Number(rideInfo.duration))) {
      const duration = Number(rideInfo.duration);
      const minutes = Math.round(duration);
      durationInfo = `‚Ä¢ Duraci√≥n: ${minutes} minutos\n`;
    }

    return `‚úÖ *¬°Viaje Completado!* üéâ

Gracias por elegir Taxi Rosa. Tu viaje ha sido completado exitosamente.

üßæ *RECIBO DE VIAJE*
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üìç *Ruta:*
üî∏ Origen: ${rideInfo.origin}
üî∏ Destino: ${rideInfo.destination}

üë®‚Äçüíº *Tu conductora:*
‚Ä¢ Nombre: ${rideInfo.driverName}
‚Ä¢ Veh√≠culo: ${rideInfo.driverVehicle}
‚Ä¢ Placa: ${rideInfo.driverPlate}

üìä *Detalles del viaje:*
‚Ä¢ C√≥digo: ${rideInfo.trackingCode}
${distanceInfo}${durationInfo}‚Ä¢ Fecha: ${formatDate(rideInfo.completionDate)}
‚Ä¢ Hora de finalizaci√≥n: ${formatTime(rideInfo.completionDate)}

üí∞ *TOTAL: ${formatPrice(rideInfo.price)}*

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚≠ê *¬°Califica tu experiencia!*
Tu opini√≥n nos ayuda a mejorar nuestro servicio.

üöñ Gracias por confiar en *Taxi Rosa* üíñ
¬°Esperamos verte pronto!`;
  }

  private createWelcomeMessage(driverInfo: {
    firstName: string;
    lastName: string;
    licencePlate: string;
    vehicle: string;
  }): string {
    return `üéâ *¬°Bienvenido a Taxi Rosa!* üöóüíñ

¬°Hola ${driverInfo.firstName}! Nos complace darte la bienvenida a nuestra familia de conductoras.

üë®‚Äçüíº *Tu informaci√≥n registrada:*
‚Ä¢ Nombre: ${driverInfo.firstName} ${driverInfo.lastName}
‚Ä¢ Veh√≠culo: ${driverInfo.vehicle}
‚Ä¢ Placa: ${driverInfo.licencePlate}

üì± *Pr√≥ximos pasos:*
1Ô∏è‚É£ Ingresa a la app de Taxi Rosa
2Ô∏è‚É£ Inicia sesi√≥n con tu n√∫mero de tel√©fono
3Ô∏è‚É£ ¬°Comienza a recibir viajes!


üí° *Consejos importantes:*
‚Ä¢ Mant√©n tu ubicaci√≥n activada
‚Ä¢ Responde r√°pidamente a las solicitudes
‚Ä¢ Brinda un excelente servicio

¬°Esperamos que tengas mucho √©xito con nosotros! üåü

Si tienes alguna pregunta, no dudes en contactarnos.

*Equipo Taxi Rosa* üíñüöó`;
  }

  async sendDriverAssignmentNotification(
    driverPhone: string,
    rideInfo: {
      origin: string;
      destination: string;
      client_name: string;
      tracking_code: string;
    }
  ): Promise<boolean> {
    try {
      const formattedPhone = this.formatPhoneForWhatsApp(driverPhone);
      const message = this.createAssignmentMessage(rideInfo);

      const payload = {
        number: formattedPhone,
        text: message
      };

      const response = await axios.post(
        `${this.evolutionApiUrl}/message/sendText/Pavola`,
        payload,
        {
          headers: {
            'Content-Type': 'application/json',
            'apikey': this.apiKey
          },
          timeout: 10000
        }
      );

      if (response.status === 200 || response.status === 201) {
        this.logger.log(
          `Notificaci√≥n de asignaci√≥n enviada exitosamente al conductora ${driverPhone} ` +
          `para la carrera ${rideInfo.tracking_code}`
        );
        return true;
      } else {
        this.logger.warn(
          `Respuesta inesperada de Evolution API: ${response.status} - ${response.statusText}`
        );
        return false;
      }
    } catch (error) {
      this.logger.error(
        `Error al enviar notificaci√≥n de asignaci√≥n al conductora ${driverPhone}: ${error.message}`,
        error.stack
      );
      return false;
    }
  }

  private createAssignmentMessage(rideInfo: {
    origin: string;
    destination: string;
    client_name: string;
    tracking_code: string;
  }): string {
    return `üöó *¬°Nuevo Viaje Asignado!*

¬°Hola! Se te ha asignado un nuevo viaje.

üìã *Detalles del viaje:*
‚Ä¢ C√≥digo: ${rideInfo.tracking_code}
‚Ä¢ Cliente: ${rideInfo.client_name}
‚Ä¢ Origen: ${rideInfo.origin}
‚Ä¢ Destino: ${rideInfo.destination}

‚ö†Ô∏è *Importante:*
‚Ä¢ Debes aceptar el viaje en la app
‚Ä¢ Si no puedes realizarlo, rech√°zalo lo antes posible

¬°Gracias por tu servicio! üôå`;
  }
} 